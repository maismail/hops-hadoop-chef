#!/bin/bash

trap "" HUP

#if [ $EUID -eq 0 ]; then
#   echo "this script must not be run as root. su to hdfs user to run"
#   exit 1
#fi

source <%=node['hops']['conf_dir']%>/hadoop-env.sh 
export PATH=<%=node['hops']['bin_dir']%>:$PATH

MR_EXAMPLES_JAR=<%= node['hops']['share_dir']%>/mapreduce/hadoop-mapreduce-examples-*.jar

SIZE=$1

DATE=`date +%Y-%m-%d-%H-%M-%S`
LOGDIR=logs/terasort/$SIZE/teravalidate/$DATE

if [ ! -d "$LOGDIR" ]
then
    mkdir -p ./$LOGDIR
fi


RESULTSFILE="./$LOGDIR/teravalidate_result.txt"


OUTPUT=/data/sandbox/poc/teragen/${SIZE}-terasort-output
REPORT=/data/sandbox/poc/teragen/${SIZE}-terasort-report


# teravalidate.sh
# Kill any running MapReduce jobs
mapred job -list | grep job_ | awk ' { system("mapred job -kill " $1) } '
# Delete the output directory
hadoop fs -rm -r -f -skipTrash ${REPORT}

./run_nmon.sh

# Run teravalidate
{ time hadoop jar $MR_EXAMPLES_JAR teravalidate \
-Dmapreduce.map.cpu.vcores=1 \
-Dmapreduce.map.java.opts=-Xmx1229m \
-Dmapreduce.map.memory.mb=1536 \
-Dmapreduce.reduce.cpu.vcores=1 \
-Dmapreduce.reduce.memory.mb=3072 \
-Dmapreduce.reduce.java.opts=-Xmx2458m \
-Dmapreduce.task.io.sort.mb=200 \
-Dmapreduce.task.io.sort.factor=48 \
-Dmapreduce.map.tasks=64 \
-Dmapreduce.reduce.tasks=32 \
${OUTPUT} ${REPORT} ; } > ${RESULTSFILE} 2>&1 

NMON_DIR=./$LOGDIR/nmon-teravalidate
mkdir -p $NMON_DIR

./stop_and_collect_nmon.sh ${NMON_DIR}